CASES = $(wildcard in*.asm) $(wildcard out*.asm)
CASESBINS = $(CASES:.asm=.bin)

# tests sources
TSTSCRS = $(wildcard .sol*.asm)
# negative test sources (tests that are supposed to fail)
NTSSRCS = $(wildcard .not_sol*.asm)

TSTBINS = $(TSTSCRS:.asm=.bin) $(NTSSRCS:.asm=.bin)

TSTLOGS = $(TSTSCRS:_i.asm=.log)
NTSLOGS = $(NTSSCRS:_i.asm=.log)
NTST = $(NTSLOGS:.log=.phony)


# TARGET = $(prg*.log)

# TODO finish, notably parse log, maybe make it play rather than all
all: $(CASESBINS) $(TSTBINS)

.PHONY: tests clean $(NTST)

# TODO check what is printed and maybe suppress it
tests: $(TSTLOGS) $(NTST)
	! grep KO $(TSTLOGS)

.not_sol%.phony: .not_sol%.log
	grep KO $<

.PRECIOUS: %.bin

.NOTINTERMEDIATE: %.log
%.log: %_i.bin $(CASESBINS)
	./check < $< > $@
.not%.log: .not%_i.bin $(CASESBINS)
	! ./check < $< > $@

%.bin: %.asm
	realpath -s --relative-to="../../../../" $< |\
	xargs -I {} sh -c 'cd ../../../../ && customasm {}'

clean:
	rm -f $(TSTLOGS) $(TSTBINS) $(TARGET)

